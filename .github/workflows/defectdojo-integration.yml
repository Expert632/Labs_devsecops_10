---
name: DefectDojo Integration

on:
  workflow_run:
    workflows: 
      - 01 - Pre-commit checks
      - 02 - Build
      - 03 - IaC + OPA
      - 04 - Docker Scan
      - 05 - CD + DAST/IAST
      - 06 - K8S Security
      - 07 - Runtime Protection
    types:
      - completed

jobs:
  send-to-defectdojo:
    name: Send Reports to DefectDojo
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts from previous workflows
        uses: actions/download-artifact@v4
        with:
          path: reports/

      - name: Aggregate all reports
        run: |
          mkdir -p aggregated_reports
          cp reports/**/* aggregated_reports/ || true
          echo "All reports aggregated."

      - name: Send aggregated reports to DefectDojo
        env:
          DD_URL: ${{ secrets.DEFECTDOJO_URL }}
          DD_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
          DD_USER: ${{ secrets.DEFECTDOJO_USER }}
        run: |
          echo "ðŸ“¤ Sending reports to DefectDojo..."
          for report in aggregated_reports/*; do
            echo "Uploading $report"
            curl -s -X POST "$DD_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DD_API_KEY" \
              -F "scan_type=Generic Findings Import" \
              -F "file=@$report" \
              -F "minimum_severity=Critical" \
              -F "active=true" \
              -F "verified=true" \
              -F "engagement=1" \
              -F "scan_date=$(date +%Y-%m-%dT%H:%M:%S)" \
              -F "tags=devsecops-lab"
          done

      - name: Display summary
        run: |
          echo "âœ… Reports sent to DefectDojo successfully."
          echo "Critical vulnerabilities are now logged and can be remediated automatically."
